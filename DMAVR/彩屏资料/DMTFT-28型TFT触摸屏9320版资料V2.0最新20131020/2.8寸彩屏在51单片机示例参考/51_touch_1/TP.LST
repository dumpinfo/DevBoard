C51 COMPILER V7.06   TP                                                                    12/13/2012 09:58:58 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE TP
OBJECT MODULE PLACED IN TP.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE TP.C BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          //¹«Ë¾£º±±·½À¶Ð¾¿Æ¼¼¿ª·¢ÓÐÏÞ¹«Ë¾
   2          //ÍøÖ·£ºwww.hrbnbc.com
   3          /*===================================================================================================  
   4          ÎÄ¼þ¹¦ÄÜÃèÊö£º320x240TFT´¥Ãþ°å¿ØÖÆ³ÌÐò£¬ÊµÏÖ´¥ÃþÎ»ÖÃ×ø±ê²É¼¯¡£
   5          ====================================================================================================*/
   6          //******************°üº¬Í·ÎÄ¼þ***************************
   7          #include <reg51.h>
   8          
   9          //**************´¥Ãþ¿ØÖÆ¶Ë¿Ú¶¨Òå********************
  10          sbit DCLK          =    P3^7;   
  11          sbit CS        =    P3^6;
  12          sbit DIN       =    P3^5;
  13          sbit BUSY      =    P3^4;       
  14          sbit DOUT      =    P3^3;                                                                                                                                                                                  
  15          sbit Penirq    =    P3^2;   //´¥Åö´¥ÃþÆÁÊ±£¬ADS7843PenirqÒý½ÅÓÉÎ´´¥ÃþÊ±µÄ¸ßµçÆ½±äÎªµÍµçÆ½
  16          
  17          
  18          //******************È«¾Ö±äÁ¿***************************
  19          struct struct1              //¶¨ÒåÒ»¸öÀàÐÍÃûÎªstruct1µÄ½á¹¹,°üº¬Á½¸ö³ÉÔ±xºÍy
  20          {
  21                  unsigned int x;         //³ÉÔ±x
  22                  unsigned int y;         //³ÉÔ±y
  23          };                   
  24          
  25          struct struct1 coordinate;      //¶¨ÒåÒ»¸öÃûÎªTp_pixµÄ½á¹¹±äÁ¿,ÓÃÓÚ´æ·Å´¥Ãþµã²ÉÑù½á¹û
  26          unsigned int  lx,ly;            //¸ù¾Ý²É¼¯µ½µÄ²ÎÊý×ª»»ÎªTFTÉÏµÄÊµ¼Ê×ø±êÖµ
  27                                                                  
  28          //Xmin¡¢maxºÍYmin¡¢Ymax·Ö±ðÊÇ´¥ÃþÆÁºá×Ý×ø±êµÄ×îÐ¡/×î´óÖµ,Èç¹ûÆ«²î´óÊ±£¬ÓÃ»§¿ÉÖØÐÂ±ê¶¨
  29          #define Xmin           0x0133
  30          #define Xmax           0x0EDA
  31          #define Ymin           0x00D0
  32          #define Ymax           0x0E2F
  33          
  34          
  35          //================================================================================================
  36          //      ÊµÏÖ¹¦ÄÜ£ºÑÓÊ±
  37          //================================================================================================
  38          void delay(unsigned int i)
  39          {
  40   1          while(i--);
  41   1      }
  42          //================================================================================================
  43          //      ÊµÏÖ¹¦ÄÜ£º      ADS7843Æô¶¯
  44          //================================================================================================
  45          void start_7843()                
  46          {
  47   1              DCLK=0;
  48   1          CS=1;
  49   1              DIN=1;
  50   1              DCLK=1;
  51   1              CS=0;
  52   1      }
  53          
  54          //================================================================================================
  55          //      ÊµÏÖ¹¦ÄÜ£º      Ð´8Î»ÃüÁîµ½´¥Ãþ¿ØÖÆIC
C51 COMPILER V7.06   TP                                                                    12/13/2012 09:58:58 PAGE 2   

  56          //      ÊäÈë²ÎÊý£º  temp ÐèÒªÐ´ÈëµÄ8Î»¿ØÖÆÃüÁî
  57          //================================================================================================
  58          void Write_7843(unsigned char temp)          //SPIÐ´8Î»ÃüÁîµ½´¥Ãþ¿ØÖÆIC
  59          {
  60   1              unsigned char i=0;
  61   1      
  62   1              for(i=0;i<8;i++)                         //Ñ­»·8´ÎÐ´ÈëÒ»×Ö½Ú
  63   1                      {
  64   2                          if(temp&0x80)DIN=1;else DIN=0;   //ÅÐ¶Ï×î¸ßÎ»ÊÇ·ñÎª1,Îª1ÔòÏòÊý¾ÝÎ»Ð´1
  65   2                              DCLK=0; delay(1);                //ËÍÒ»¸öÂö³å£¬ÉÏÉýÑØÓÐÐ§£¬½«DINÎ»Êý¾ÝËÍÈëµ½IC
  66   2                              DCLK=1; delay(1);                
  67   2                              temp<<=1;                        //´ýÐ´Êý¾Ý×óÒÆ1Î»£¬×¼±¸ºÃÐ´ÏÂÒ»Î»Êý¾Ý
  68   2                      }
  69   1      }
  70          
  71          //================================================================================================
  72          //      ÊµÏÖ¹¦ÄÜ£º      ´Ó´¥Ãþ¿ØÖÆIC¶Á8Î»Êý¾Ýµ½¿ØÖÆÆ÷
  73          //      ·µ»Ø²ÎÊý£º  temp ÐèÒªÐ´ÈëµÄ8Î»¿ØÖÆÃüÁî
  74          //================================================================================================
  75          unsigned int Read_7843()                     //SPI ¶ÁÊý¾Ý
  76          {
  77   1              unsigned char i=0;
  78   1              unsigned int temp=0;
  79   1      
  80   1              for(i=0;i<12;i++)                        //Ñ­»·12´Î¶ÁÈ¡12Î»½á¹û
  81   1               { 
  82   2             temp<<=1;                             //temp×óÒÆÒ»Î»£¬×¼±¸¶ÁÈ¡ÏÂÒ»Î»
  83   2                 DCLK=1; delay(1);                     //ÏÂ½µÑØÓÐÐ§
  84   2                 DCLK=0; delay(1);
  85   2                 if(DOUT) temp++;                      //ÅÐ¶Ï¿ØÖÆICËÍ³öµÄÒ»Î»Êý¾ÝÊÇ·ñÎª1,Èç¹ûÎª1,¸³¸øtempµÄ×îµÍÎ»
  86   2           }
  87   1          return(temp);                            //·µ»Ø½á¹û
  88   1      }       
  89          
  90          //================================================================================================
  91          //      ÊµÏÖ¹¦ÄÜ£º¶ÁÈ¡´¥ÃþµãXÖáºÍYÖáµçÑ¹Öµ
  92          //      ·µ»Ø²ÎÊý£ºpix ¶ÁÈ¡µ½µÄ´¥ÃþµãµçÑ¹Öµ
  93          //================================================================================================
  94          struct struct1 AD7843()            
  95          {
  96   1              struct struct1 pix;
  97   1              CS=0;
  98   1      
  99   1              Write_7843(0x90);        //ËÍ¿ØÖÆ×Ö 10010000 ¼´ÓÃ²î·Ö·½Ê½¶ÁX×ø±ê£¬ÏêÏ¸Çë¼ûÓÐ¹Ø×ÊÁÏ
 100   1              DCLK=1; delay(1); 
 101   1              DCLK=0; delay(1); 
 102   1              pix.y=Read_7843();
 103   1      
 104   1              Write_7843(0xD0);        //ËÍ¿ØÖÆ×Ö 11010000 ¼´ÓÃ²î·Ö·½Ê½¶ÁY×ø±ê ÏêÏ¸Çë¼ûÓÐ¹Ø×ÊÁÏ
 105   1              DCLK=1; delay(1); 
 106   1              DCLK=0; delay(1); 
 107   1              pix.x=Read_7843();
 108   1      
 109   1              CS=1; 
 110   1              return pix;
 111   1      }
 112          
 113          //================================================================================================
 114          //      ÊµÏÖ¹¦ÄÜ£ºÈí¼þÂË²¨£¬ÂËµô²¨¶¯¹ý´óµÄ²ÉÑùµã
 115          //      ·µ»Ø²ÎÊý£ºflag ²É¼¯Êý¾ÝÊÇ·ñÓÐÐ§±êÖ¾,flag=1;ÔòÊý¾ÝÓÐÐ§
 116          //================================================================================================
 117          unsigned char pix_filter(struct struct1 pix1,struct struct1 pix2)
C51 COMPILER V7.06   TP                                                                    12/13/2012 09:58:58 PAGE 3   

 118          {
 119   1              unsigned char flag=0;
 120   1              int x=pix1.x>pix2.x?pix1.x-pix2.x:pix2.x-pix1.x;  //XÖáÁ½´Î²ÉÑù¾ø¶ÔÖµ
 121   1              int y=pix1.y>pix2.y?pix1.y-pix2.y:pix2.y-pix1.y;  //YÖáÁ½´Î²ÉÑù¾ø¶ÔÖµ
 122   1              if(x<15&&y<15)                                    //Èí¼þÂË²¨£¬2´ÎÈ¡ÑùµÄÖµÏà²îÌ«´óµÄÊÓÎªÔëÉù
 123   1              {
 124   2                      flag=1;
 125   2                      coordinate.x=(pix1.x+pix2.x)/2;               //ÇóÁ½´Î²ÉÑùÆ½¾ùÖµ
 126   2                      coordinate.y=(pix1.y+pix2.y)/2;
 127   2              }       
 128   1              return flag;
 129   1      }
 130          
 131          //================================================================================================
 132          //      ÊµÏÖ¹¦ÄÜ£º¶ÁÈ¡²É¼¯½á¹û,Á½´ÎÈ¡¾ùÖµ
 133          //================================================================================================
 134          unsigned char Getpix() //È¡²ÉÑùÖµ£¬´Ë´¦Ê¹ÓÃÈí¼þÂË²¨£¬2´ÎÈ¡ÑùµÄÖµÏà²îÌ«´óµÄÊÓÎªÔëÉù
 135          {
 136   1          unsigned char flag=0;
 137   1              struct struct1 pix1;
 138   1              struct struct1 pix2; 
 139   1      
 140   1              if (Penirq==0)
 141   1                      {       
 142   2                      pix1=AD7843();
 143   2                      pix2=AD7843();
 144   2      
 145   2                              if(pix_filter(pix1,pix2)==1) //µÃµ½µ±Ç°TPµÄÈ¡ÑùÖµ£¬´Ë´¦Ê¹ÓÃÈí¼þÂË²¨£¬2´ÎÈ¡ÑùµÄÖµÏà²îÌ«´óµÄÊÓÎªÔëÉù
 146   2                                      {
 147   3                        if((coordinate.x>Xmin)&&(coordinate.y>Ymin))
 148   3                         {
 149   4                                      lx=240.0*(coordinate.x-Xmin)/(Xmax-Xmin);  //×ø±ê×ª»»£¬¼´¸ù¾Ý²ÉÑùÖµ¼ÆËãÊµ¼Ê×ø±êÖµ
 150   4                                          ly=320.0*(coordinate.y-Ymin)/(Ymax-Ymin);  //Xmin¡¢maxºÍYmin¡¢Ymax·Ö±ðÊÇ´¥ÃþÆÁºá×Ý×ø±êµÄ×îÐ¡/×î´óÖ
             -µ
 151   4                                          flag=1;
 152   4                         }
 153   3                                      }                                
 154   2                      }
 155   1      
 156   1              return flag;    
 157   1      
 158   1      }
 159          
 160          
 161          
 162          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    467    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8      21
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
