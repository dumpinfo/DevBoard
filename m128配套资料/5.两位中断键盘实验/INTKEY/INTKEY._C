//DMAVR-M16ÖĞ¶ÏÊ½¶ÀÁ¢¼üÅÌÊ¾Àı³ÌĞò£¬¼üÖµ±ä»¯¿ÉÄÜ²»ÎÈ£¬ÒòÎª¼üÅÌÓ²¼şµÄ¶¶¶¯Ô­Òò
//Á½¸öÖĞ¶Ï¼üÅÌ½øĞĞ¼Ó1»òÕß¼õ1¼ÆÊı
//×¢ÒâICCAVRÖĞ¶Ïº¯Êı´¦Àí·½·¨£¬ÖĞ¶ÏÏòÁ¿ºÅ¿ÉÒÔÔÚÍ·ÎÄ¼şiom128v.hÖĞ²éÕÒ
//±àÒë»·¾³ ICCAVR 
//ÏµÍ³Ê±ÖÓ7.3728MHZ£¬ÉèÖÃÈÛË¿Î»ÎªÍâ²¿¸ßÆµÊ¯Ó¢¾§ÌåÕñµ
//×÷Õß£ºÖÒĞËµç×ÓÔª¼şµê
//ÈÕÆÚ£º2010.05.24

//***********************************************************************
//			°üº¬ÎÄ¼ş
//***********************************************************************

#include <string.h>
#include <stdio.h>
#include <delay.h>
#include <iom128v.h>

#define Data_IO	        PORTA                //Êı¾İ¿Ú
#define Data_DDR        DDRA                 //Êı¾İ¿Ú·½Ïò¼Ä´æÆ÷
#define D_LE0	        PORTD &= ~(1 << PD4) //ÊıÂë¹Ü¶Î¿ØÖÆÎ»Îª0
#define D_LE1           PORTD |= (1 << PD4)  //ÊıÂë¹Ü¶Î¿ØÖÆÎ»Îª1
#define W_LE0	        PORTD &= ~(1 << PD5) //ÊıÂë¹ÜÎ»¿ØÖÆÎ»Îª0
#define W_LE1           PORTD |= (1 << PD5)  //ÊıÂë¹ÜÎ»¿ØÖÆÎ»Îª1

#define uchar           unsigned char
#define uint            unsigned int

uchar count;                                  //¶¨Òå¼üÅÌ¼ÆÊı±äÁ¿

//***********************************************************************
//			¹²ÒõÊıÂë¹ÜÏÔÊ¾µÄ¶ÏÂë±í
//***********************************************************************

uchar table[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,
	           0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};

//***********************************************************************
//			IO¶Ë¿Ú³õÊ¼»¯
//***********************************************************************

void System_Init()
{
    Data_IO=0xFF;             //Êı¾İ¿ÚÎªÊä³ö
    Data_DDR=0xFF;

	PORTD=0x7F;               //PD0 PD1ÉèÖÃÎªÊäÈë
	DDRD=0x70;                //PD0 PD1ÉÏÀ­µç×èÊ¹ÄÜÓĞĞ§
	
	PORTB=0xFF;				  //¹Ø±Õ·¢¹â¶ş¼«¹Ü
	DDRB=0xFF;
}

//*************************************************************************
//			74HC573¿ØÖÆÊıÂë¹Ü¶¯Ì¬É¨ÃèÏÔÊ¾º¯Êı
//*************************************************************************

void Display_Key(uchar num)
{
	 uchar i,j;
	 System_Init();
     j=0x01;                   //´ËÊı¾İÓÃÀ´¿ØÖÆÎ»Ñ¡
  for(i=0;i<8;i++)
  {
    D_LE1;                    //¿ØÖÆÊıÂë¹Ü¶ÎÊı¾İµÄ74HC573µÄLE¹Ü½ÅÖÃ¸ß
    W_LE1;                    //¿ØÖÆÊıÂë¹ÜÎ»µÄ74HC573µÄLE¹Ü½ÅÖÃ¸ß
    Data_IO=0x00;             //ÉèÖÃÏÔÊ¾µÄÎ»£¬Ò²¾ÍÊÇÄÄ¸öÊıÂë¹ÜÁÁ£¬ÕâÀïÊÇ°Ë¸öÒ»ÆğÏÔÊ¾
    W_LE0;                    //Ëø´æÎ»Êı¾İ£¬ÏÂÃæËÍÉÏ¶ÎÊı¾İÒÔºó£¬¾ÍÏÔÊ¾³öÀ´ÁË
	j=(j<<1);
    Data_IO=table[num];       //ËÍÒªÏÔÊ¾µÄÊı¾İ£¬¾ÍÊÇ¶ÎÊı¾İ£¬ÈçÏÔÊ¾0ËÍµÄÊÇ0x3f
    D_LE0;                    //Ëø´æ¶ÎÊı¾İ£¬ÊıÂë¹ÜÁÁÒ»¸öÊ±¼äÆ¬¿Ì
    delay_nms(1);             //ÏÔÊ¾Ò»¸öÊ±¼äÆ¬¿Ì£¬»áÓ°ÏìÁÁ¶ÈºÍÉÁË¸ĞÔ

  }

}

void Interrupt_Init()
{
  EIMSK|=0x03;                                     //Ê¹ÄÜÍâ²¿ÖĞ¶Ï0ºÍÍâ²¿ÖĞ¶Ï1
  EICRA=0x0A;                                     //ÏÂ½µÑØ´¥·¢·½Ê½
  MCUCSR=0x00;                                    //¿ØÖÆºÍ×´Ì¬¼Ä´æÆ÷³õÊ¼»¯
}

//*************************************************************************
//	   ÖĞ¶Ï·şÎñ×Ó³ÌĞò
//*************************************************************************

#pragma interrupt_handler  INT0_ISR:iv_INT0 //int0_ISR£ºÖĞ¶Ïº¯ÊıÃû£¬½Ó×ÅÊÇÖĞ¶ÏÏòÁ¿ºÅ
void INT0_ISR() 	 				  		//ÖĞ¶Ï0·şÎñ³ÌĞò
   { 
   	 if(++count>=16) 
   	 count=0;
   } 

#pragma interrupt_handler  INT1_ISR:iv_INT1
void INT1_ISR() 	 				 	   //ÖĞ¶Ï1·şÎñ³ÌĞò
   { 
   	 if(count) --count;
   	 else count=15;
  }


//*************************************************************************
//			Ö÷³ÌĞò
//*************************************************************************
int main(void)
{
  System_Init();                             //ÏµÍ³³õÊ¼»¯
  Interrupt_Init();                          //ÖĞ¶ÏÅäÖÃ³õÊ¼»¯
  SREG|=0x80;                                //¿ªÆôÈ«¾ÖÖĞ¶Ï
  while(1)
  {
    Display_Key(count);                     //ÏÔÊ¾¼üÖµ
  }
}
